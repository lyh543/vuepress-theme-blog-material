import moment from "./moment";

/**
 * parse post key (hex digit) to integer
 * @param key {String} key of posts, like 'v-1234abcd'
 * @returns {number}
 */
export function parsePostKeyToInt(key) {
  return parseInt(key.slice(2), 16);
}


/**
 * generate random image for post by its key
 * @param page {{key: string}} vuepress posts
 * @returns {string} the link of image
 */
export function generatePostImage(page) {
  const imageLength = 19;
  const imageLink = '/theme/random/material-#.png';

  const index = parsePostKeyToInt(page.key) % imageLength + 1;
  return imageLink.replace('#', String(index));
}


/**
 * parse datetime to date
 * @param datetime {String} datetime (maybe of different format)
 * @param dateFormat {String} vm.$themeConfig.dateFormat
 * @returns {string} date
 */
export function convertDatetimeToDate(datetime, dateFormat = 'YYYY-MM-DD') {
  return moment(new Date(datetime)).format(dateFormat);
}


/**
 * get postDate of a post
 * @param post
 * @param dateFormat {string}
 * @returns {string}
 */
export function getPostDate(post, dateFormat = 'YYYY-MM-DD') {
  const date = post.frontmatter.date;
  return date ? convertDatetimeToDate(date, dateFormat) : "";
}


/**
 * get lastUpdated of a post
 * @param post
 * @param dateFormat {string}
 * @returns {string}
 */
export function getLastUpdatedDate(post, dateFormat = 'YYYY-MM-DD') {
  const date = post.lastUpdated;
  return date ? convertDatetimeToDate(date, dateFormat) : "";
}


/**
 * get postDate of a post. If postDate is null, get lastUpdated instead
 * @param post
 * @param dateFormat {string}
 * @returns {string}
 */
export function getPostDateOrLastUpdated(post, dateFormat = 'YYYY-MM-DD') {
  const date = post.frontmatter.date ? post.frontmatter.date : post.lastUpdated;
  return date ? convertDatetimeToDate(date, dateFormat) : "";
}


/**
 * build a Vuetify TreeView of Toc by VuePress headers
 * @param headers {Array<{title, slug, level}>}
 * @return {Array<{id, name, slug, children}>}
 */
export function buildTocTree(headers) {
  let index = 0;
  function createNode(name = '', slug = '#') {
    return {
      id: slug,
      name,
      slug,
      children: []
    };
  }

  let root = createNode();

  function pushToLastNodeOfThatLevel(node, level) {
    let father = root;
    for (let i = 0; i < level; i++) {
      // it may happen when
      // a node of level 4 will be pushed into children of a node of level 2
      if (father.children.length === 0)
        father.children.push(createNode());
      father = father.children[father.children.length-1];
    }
    father.children.push(node);
  }

  for (const header of headers) {
    const {title, slug, level} = header;
    const node = createNode(title, slug);
    pushToLastNodeOfThatLevel(node, level - 1);
  }

  let children = root.children;
  // if a child is the only child of root, and is created by function
  // then we can substitute its child for root
  // to make the tree simpler
  while (children.length === 1 && children[0].name === '')
    children = children[0].children;
  return children;
}
